#!/bin/bash

#We get the name of the folder to save the files
folder=$1

filename1=logs_general
filename3=errors_main


error_situation=0
time_error_start=0
time_error_now=0


#log purposes
date --iso-8601=ns >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename1"
echo "The collection of GPS coordinates has started" >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename1"

# On the one hand, the coordinates and the time will be saved in the variables: latitude, longitude and time.

x=$(date)
namefile=GPScoordinates_$x
echo "" >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$namefile"
sudo chmod 777 /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$namefile"


while true; do



########################################## Acquiring the coordinates info and saving them ###########################

coordinatesInfo=$(python /home/upboard/Desktop/UpBoard-Code-and-Results/CodeOmni/gpsOutput.py)
echo $coordinatesInfo
date --iso-8601=ns >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$namefile"
echo "$coordinatesInfo" >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$namefile"

latitude=$(echo "$coordinatesInfo" | sed -n '1p')
longitude=$(echo "$coordinatesInfo" | sed -n '2p')


echo " " >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$namefile" #Blank space

#Terminal purposes
echo -e " Lat" $latitude"\n" "Lon" $longitude"\n"




###################### ESTABLISHING AN ERROR SITUATION OR DISABLING IT ############################################

if [ "$error_situation" == "0" ] && ([ "$latitude" == "nan" ] || [ "$longitude" == "nan" ]); then #The error appears --> WE ENTER IN ERROR STATE

	time_error_start=$(date +%s%N)
	error_situation=1
	#log terminal
	echo -e "Error started. Reason: coordinates nan"
	#log purposes
	date --iso-8601=ns >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename3"
	echo -e "Coordinates lost (nan). Error started \n" >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename3"

elif [ "$error_situation" == "1" ] && ([ "$latitude" != "nan" ] && [ "$longitude" != "nan" ]); then #The error disappears --> WE LEAVE THE ERROR STATE

	time_error_start=0
	time_error_now=0
	error_situation=0
	#log terminal purposes
	echo -e "Error FINISHED. Reason: coordinates finished to be nan"
	#log purposes
	date --iso-8601=ns >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename3"
	echo -e "Coordinates recovered again. Error finished \n" >> /home/upboard/Desktop/UpBoard-Code-and-Results/Results/"$folder"/"$filename3"
fi






done

